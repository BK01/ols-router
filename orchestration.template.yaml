apiVersion: template.openshift.io/v1
kind: Template
labels:
  template: cassandra-test-template
metadata:
  name: cassandra-test-template
  annotations:
    openshift.io/display-name: "DataBC Route Planner API"
    description: >-
      An example Route Planner API application with a Cassandra cluster,
      a Data Admin WebApp and a Router Planer API. For more information
      about using this template, including OpenShift considerations, see
      https://docs.openshift.com/container-platform/4.6/openshift_images/using-templates.html.
      Note: Logs for router nodes are persisted in PCVs.

    openshift.io/long-description: >-
      This template defines resources needed to develop a Route Planner API
      application, including a build configuration, application DeploymentConfig, and
      configuration database DeploymentConfig.  The database is stored in
      persistent storage.

    tags: "router,java,gis,location"
    iconClass: icon-spring
    openshift.io/provider-display-name: "Data Systems and Services, DataBC"
    openshift.io/documentation-url: "https://github.com/bcgov/ols-router"
    openshift.io/support-url: "https://access.redhat.com"

message: |-
  Your admin credentials are ${ADMIN_USERNAME}:${ADMIN_PASSWORD}
  The following objects have been created in you project:

  StatefulSet
    cassandra-${APP_NAME} - Cassandra cluster
    ols-router-web        - Route Planne API cluster

  Service
    cassandra-${APP_NAME} - Cassandra
    ols-router-web        - Route Planner API WebApp
    ols-router-admin      - Config Admin WebApp

  Route
    ols-router-admin      - Router - Config Admin WebApp

  DeploymentConfig
    N/A

  Deployment
    ols-router-admin      - Config Admin WebApp - Deployment

  NetworkPolicy
    allow-from-openshift-ingress
    allow-same-namespace
    deny-by-default
    allow-traffic-from-gateway-to-${APP_NAME}-${ENV}

parameters:
  - name: TOOLS_NAMESPACE
    description: The tools namspace where image streams will be pulled from.
    required: true
  - name: APP_NAME
    description: A common label that will be applied to all objects
    displayName: App Label
    required: true
    value: router
  - name: ENV
    description: The environment i.e. on of -dev, -test, -prod.  This will be appended to hostnames so routes don't collide across namespaces.
    displayName: App Environment
    required: true

  - name: ROUTER_ADMIN_HOSTNAME
    description: The hostname for the Admin App.
    displayName: Admin configurtion app hostname
    required: true
    value: router-admin
  - name: ROUTER_API_HOSTNAME
    description: The hostname for the Router API App.
    displayName: Router API endpoint hostname.
    required: true
    value: router-api
  - name: ROUTE_SUBDOMAIN
    description: Default route subdomain - use apps.silver.devops.gov.bc.ca
    displayName: Route subdomain
    required: true
    value:  apps.silver.devops.gov.bc.ca

  - name: DEFAULT_DOCKERCFG
    description: default-dockercfg secret for the 'default' Service account
    displayName: Default service account docker Secret
    required: true
    # e.g.
    # value: default-dockercfg-jgsbn
  - name: DOCKER_SECRET
    description: docker-secret for the 'default' Service account for Artifactory
    displayName: Default service account Artifactory docker Secret
    required: true
    value:  docker-secret

  - name: CASSANDRA_REPLICA_COUNT
    description: "The number of Cassandra replicas to deploy"
    displayName: Cassandra Replica Count
    required: true
    value: "3"

  - name: ROUTER_REPLICA_COUNT
    description: "The number of Router Web replicas to deploy"
    displayName: Router Replica Count
    required: true
    value: "4"
  - name: "ROUTER_IS_TAG"
    description: "The image stream tag to use for the ols-router-sidecar"
    required: true
  - name: "DATA_ADMIN_IS_TAG"
    description: "The image stream tag to use for the ols-admin-sidecar"
    required: true

  - name: DATASTORE_URL
    description: "the URL for the datastore"
    required: true
    value: https://router-datastore-prod.apps.silver.devops.gov.bc.ca/router/

objects:

# Config maps necessary to load data into cassandra bgeo keyspace
- kind: ConfigMap
  apiVersion: v1
  metadata:
    creationTimestamp: null
    name: bgeo-configuration-parameters
  data:
    bgeo_configuration_parameters.csv: |-
      app_id^config_param_name^config_param_value
      ROUTER^baseSrsCode^3005
      ROUTER^copyrightLicenseURI^https://www2.gov.bc.ca/gov/content?id=A519A56BC2BF44E4A008B33FCF527F61
      ROUTER^copyrightNotice^Copyright 2020 Province of British Columbia - Open Government License
      ROUTER^dataSource.baseFileUrl^${DATASTORE_URL}
      ROUTER^dataSource.baseFileUrl.devel^http://ols-router-data:8080
      ROUTER^dataSource.className^ca.bc.gov.ols.router.datasource.FileRouterDataSource
      ROUTER^defaultDisableOptions^TD,EV,SC,TF
      ROUTER^defaultEnableOptions^GDF,LDF,TR,XC,TC
      ROUTER^defaultGlobalDistortionField^alleyway:1.2,alleyway.truck:1.1,arterial_major:1.01,arterial_major.truck:1.01,arterial_minor:1.01,arterial_minor.truck:1.01,collector_major:1.01,collector_major.truck:1.01,collector_minor:1.01,collector_minor.truck:1.01,driveway:1.2,driveway.truck:1.1,ferry:1,ferry.truck:1,freeway:1,freeway.truck:1,highway_major:1,highway_major.truck:1,highway_minor:1,highway_minor.truck:1,lane:1.01,lane.truck:1.01,local:1.1,local.truck:1.05,ramp:1,ramp.truck:1,recreation:1.2,recreation.truck:1.1,resource:1.2,resource.truck:1.1,restricted:1.2,restricted.truck:1.1,service:1.2,service.truck:1.1,strata:1.2,strata.truck:1.1,yield_lane:1.01,yield_lane.truck:1.01
      ROUTER^defaultTruckRouteMultiplier^9
      ROUTER^defaultTurnCost^3,1,10,5
      ROUTER^defaultXingCost^3,10,7,1.2
      ROUTER^disclaimer^https://www2.gov.bc.ca/gov/content?id=79F93E018712422FBC8E674A67A70535
      ROUTER^glossaryBaseUrl^https://github.com/bcgov/ols-router/blob/gh-pages/glossary.md
      ROUTER^kmlStylesUrl^http://openmaps.gov.bc.ca/kml/router_results_styles.kml
      ROUTER^maxOptimalRoutePoints^100
      ROUTER^maxPairs^1000
      ROUTER^maxRoutePoints^100
      ROUTER^moreInfoUrl^https://www2.gov.bc.ca/gov/content?id=9D99E684CCD042CD88FADC51E079B4B5
      ROUTER^privacyStatement^https://www2.gov.bc.ca/gov/content?id=9E890E16955E4FF4BF3B0E07B4722932

    bgeo_keyspace_config.cql: |-
      CREATE KEYSPACE bgeo WITH replication = {'class': 'SimpleStrategy', 'replication_factor': '2'}  AND durable_writes = true;

      CREATE TABLE bgeo.bgeo_configuration_parameters (
          app_id text,
          config_param_name text,
          config_param_value text,
          PRIMARY KEY (app_id, config_param_name)
      ) WITH CLUSTERING ORDER BY (config_param_name ASC)
          AND bloom_filter_fp_chance = 0.01
          AND caching = {'keys': 'ALL', 'rows_per_partition': 'NONE'}
          AND comment = ''
          AND compaction = {'class': 'org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy', 'max_threshold': '32', 'min_threshold': '4'}
          AND compression = {'chunk_length_in_kb': '64', 'class': 'org.apache.cassandra.io.compress.LZ4Compressor'}
          AND crc_check_chance = 1.0
          AND dclocal_read_repair_chance = 0.1
          AND default_time_to_live = 0
          AND gc_grace_seconds = 864000
          AND max_index_interval = 2048
          AND memtable_flush_period_in_ms = 0
          AND min_index_interval = 128
          AND read_repair_chance = 0.0
          AND speculative_retry = '99PERCENTILE';

# PVC for state-ledger
- kind: PersistentVolumeClaim
  # This is used to track the initializattion of cassandra and the BGEO Keyspace.
  # It is mounted in each init containers in turn, for the router, the Admin App
  # and router container (though it's not really necessary)
  apiVersion: v1
  metadata:
    name: state-ledger
  spec:
    accessModes:
      - ReadWriteMany
    resources:
      requests:
        storage: 20Mi
    storageClassName: netapp-file-standard
    volumeMode: Filesystem
  status: {}


# Cassandra StatefulSet
- kind: StatefulSet
  apiVersion: apps/v1
  metadata:
    labels:
      app: cassandra-${APP_NAME}
      statefulset: cassandra-${APP_NAME}
    name: cassandra-${APP_NAME}
  spec:
    podManagementPolicy: OrderedReady
    replicas: ${{CASSANDRA_REPLICA_COUNT}}
    revisionHistoryLimit: 10
    selector:
      matchLabels:
        statefulset: cassandra-${APP_NAME}
    serviceName: cassandra-${APP_NAME}
    template:
      metadata:
        labels:
          app: cassandra-${APP_NAME}
          statefulset: cassandra-${APP_NAME}
      spec:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: statefulset
                  operator: In
                  values:
                  - cassandra-${APP_NAME}
              topologyKey: kubernetes.io/hostname
        containers:
        - command:
          - /docker-entrypoint.sh
          - -R
          env:
          - name: MAX_HEAP_SIZE
            #value: 1500M
            value: 2500M
          - name: HEAP_NEWSIZE
            value: 100M
          - name: CASSANDRA_LISTEN_ADDRESS
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          - name: CASSANDRA_SEEDS
            value: cassandra-${APP_NAME}-0.cassandra-${APP_NAME}
          - name: CASSANDRA_CLUSTER_NAME
            value: k8s
          - name: CASSANDRA_DC
            value: DC1
          - name: CASSANDRA_RACK
            value: Rack1
          - name: CASSANDRA_ENDPOINT_SNITCH
            value: GossipingPropertyFileSnitch
          image: docker-remote.artifacts.developer.gov.bc.ca/cassandra:3.11.2
          #image: tools/cassandra:3.11.2
          #image: image-registry.openshift-image-registry.svc:5000/tools/cassandra:3.11.2
          #image: image-registry.openshift-image-registry.svc:5000/tools/cassandra:3.11
          #image: image-registry.openshift-image-registry.svc:5000/dev/cassandra:3.11
          #image: registry.hub.docker.com/library/cassandra:3.11
          imagePullPolicy: Always
          lifecycle:
            preStop:
              exec:
                command:
                - /bin/sh
                - -c
                - nodetool drain
          name: cassandra-${APP_NAME}
          ports:
          - containerPort: 7000
            name: intra-node
            protocol: TCP
          - containerPort: 7001
            name: tls-intra-node
            protocol: TCP
          - containerPort: 7199
            name: jmx
            protocol: TCP
          - containerPort: 9042
            name: cql
            protocol: TCP
          resources:
            limits:
              cpu: 500m
              #memory: 2Gi
              memory: 4Gi
            requests:
              cpu: 250m
              memory: 1Gi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /var/lib/cassandra
            name: cassandra-data
          - mountPath: /var/log/cassandra
            name: cassandra-logs
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        terminationGracePeriodSeconds: 30
        imagePullSecrets:
        - name: ${DOCKER_SECRET}
        volumes:
        - emptyDir: {}
          name: cassandra-logs
    updateStrategy:
      rollingUpdate:
        partition: 0
      type: RollingUpdate
    volumeClaimTemplates:
    - metadata:
        name: cassandra-data
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        #storageClassName: netapp-block-standard

# Cassandra Service
- kind: Service
  apiVersion: v1
  metadata:
    labels:
      app: cassandra-${APP_NAME}
    name: cassandra-${APP_NAME}
  spec:
    clusterIP: None
    ports:
      - port: 9042
        protocol: TCP
        targetPort: 9042
    selector:
      app: cassandra-${APP_NAME}
    sessionAffinity: None
    type: ClusterIP

# ols-router-web StatefulSet
- kind: StatefulSet
  apiVersion: apps/v1
  metadata:
    labels:
      app: ols-router-web
      statefulset: ols-router-web
    name: ols-router-web
  spec:
    podManagementPolicy: OrderedReady
    replicas: ${{ROUTER_REPLICA_COUNT}}
    revisionHistoryLimit: 10
    selector:
      matchLabels:
        statefulset: ols-router-web
    serviceName: ols-router-web
    template:
      metadata:
        labels:
          app: ols-router-web
          statefulset: ols-router-web
      spec:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: statefulset
                  operator: In
                  values:
                  - ols-router-web
              topologyKey: kubernetes.io/hostname
        imagePullSecrets:
        - name: ${DOCKER_SECRET}
        - name: ${DEFAULT_DOCKERCFG}

        initContainers:
        - name: init-copy-war
          # Copy the ols-router.war to the PVC
          command:
          - cp
          - /ols-router.war
          - /app/ROOT.war
          image: image-registry.openshift-image-registry.svc:5000/${TOOLS_NAMESPACE}/ols-router-sidecar:${ROUTER_IS_TAG}
          imagePullPolicy: Always
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /app
            name: app-volume

        - name: init-wait-for-cassandra
          image: docker-remote.artifacts.developer.gov.bc.ca/busybox:1.33.1
          # Wait for cassandra service cassandra-${APP_NAME} to be ready.
          # In other words, wait for cassandra to 'boot'
          #
          # /state-ledger/cassandra-up is created after the services comes up.
          # this will be used by subsequent pods - if the file exists, that stage of
          # the init has completed.
          command:
            - 'sh'
            - '-c'
            - if [[ -f /state-ledger/cassandra-up ]] ;
              then
                exit 0;
              else
                while (:);
                do
                  nc -w 1 cassandra-${APP_NAME} 9042;
                  if [ $? == 0 ];
                    then break;
                  fi;
                  printf .;
                  sleep 1;
                done;
                touch /state-ledger/cassandra-up;
              fi;
          volumeMounts:
          - name: router-logs
            mountPath: /app
          - name: state-ledger-vol
            mountPath: /state-ledger

        - name: init-bgeo-keyspace
          image: docker-remote.artifacts.developer.gov.bc.ca/cassandra:3.11.2
          # Create the bgeo keyspace and the bgeo_configuration_parameters table.
          #
          # The /state-ledger/keyspace-bgeo-creaed is checked by subseqent pods -
          # if the init container finds this file, there's no need to init the bgeo
          # keyspace.
          command:
            - 'sh'
            - '-c'
            - if [ -f /state-ledger/keyspace-bgeo-created ] ;
              then
                exit 0;
              else
                cqlsh cassandra-${APP_NAME} -f /apps/bgeo/bgeo_keyspace_config.cql;
                touch /state-ledger/keyspace-bgeo-created;
              fi;
          volumeMounts:
          - name: bgeo-configuration-parameters
            mountPath: /apps/bgeo
          - name: state-ledger-vol
            mountPath: /state-ledger

        - name: load-bgeo-keyspace
          # Load the bgeo.bgeo_configuration_parameters table with data from
          # the config map.
          #
          # the /state-ledger/keyspace-bgeo-loaded is created after the bego
          # keyspace has been loaded.   All subsequent router Pods are configured
          # with init containers that check for this file.  If it exists,
          # the bgeo keyspace is loaded with required data.
          image: docker-remote.artifacts.developer.gov.bc.ca/cassandra:3.11.2
          command:
            - 'sh'
            - '-c'
            - if [ -f /state-ledger/keyspace-bgeo-loaded ] ;
              then
                exit 0;
              else
                cqlsh cassandra-${APP_NAME} -k bgeo -e "COPY bgeo.bgeo_configuration_parameters FROM '/apps/bgeo/bgeo_configuration_parameters.csv' WITH DELIMITER='^' AND HEADER=TRUE";
                touch /state-ledger/keyspace-bgeo-loaded;
              fi;
              echo
              echo Sleeping for 5 more seonds.
              sleep 5;
          volumeMounts:
          - name: bgeo-configuration-parameters
            mountPath: /apps/bgeo
          - name: state-ledger-vol
            mountPath: /state-ledger


        containers:

        - command:
          - catalina.sh
          - run
          env:
          - name: CATALINA_BASE
            value: /usr/local/tomcat
          - name: JAVA_OPTS
            value: -XX:OnOutOfMemoryError="kill -15 %p" -XX:MaxRAMPercentage=75.0
          - name: OLS_CASSANDRA_LOCAL_DATACENTER
            value: DC1
          - name: OLS_CASSANDRA_CONTACT_POINT
            value: cassandra-${APP_NAME}
          - name: OLS_CASSANDRA_KEYSPACE
            value: bgeo
          image: docker-remote.artifacts.developer.gov.bc.ca/tomcat:9-jre11-slim
          imagePullPolicy: IfNotPresent
          name: tomcat
          ports:
          - containerPort: 8080
            name: catalina-http
            protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /ping
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 120
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              cpu: "500m"
              memory: 2Gi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /usr/local/tomcat/logs
            name: router-logs
          - mountPath: /usr/local/tomcat/work
            name: tc-work
          - mountPath: /usr/local/tomcat/temp
            name: tc-work
          - mountPath: /usr/local/tomcat/conf/Catalina
            name: tc-conf
          - mountPath: /usr/local/tomcat/webapps
            name: app-volume
          - name: state-ledger-vol
            mountPath: /state-ledger


        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        terminationGracePeriodSeconds: 30
        volumes:
        - emptyDir: {}
          name: tc-work
        - emptyDir: {}
          name: tc-conf
        - emptyDir: {}
          name: app-volume
        - name: bgeo-configuration-parameters
          configMap:
            name: bgeo-configuration-parameters
        - name: state-ledger-vol
          persistentVolumeClaim:
            claimName: state-ledger

    updateStrategy:
      rollingUpdate:
        partition: 0
      type: RollingUpdate
    volumeClaimTemplates:
    - metadata:
        name: router-logs
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi

# Service for ols-router-web
- kind: Service
  apiVersion: v1
  metadata:
    creationTimestamp: null
    name: ols-router-web
  spec:
    ports:
    - name: ols-router-web
      port: 8080
      protocol: TCP
      targetPort: 8080
    selector:
      app: ols-router-web
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}

# ols-router-admin Deployment
- kind: Deployment
  apiVersion: apps/v1
  metadata:
    generation: 1
    labels:
      app: ols-router-admin
      name: ols-router-admin
      template: ols-router-admin
    name: ols-router-admin
  spec:
    progressDeadlineSeconds: 600
    replicas: 1
    revisionHistoryLimit: 10
    selector:
      matchLabels:
        app: ols-router-admin
        name: ols-router-admin
    strategy:
      type: Recreate
    template:
      metadata:
        creationTimestamp: null
        labels:
          app: ols-router-admin
          name: ols-router-admin
      spec:
        imagePullSecrets:
          - name: ${DOCKER_SECRET}
          - name: ${DEFAULT_DOCKERCFG}
          # e.g.
          #- name: default-dockercfg-hb696
        containers:
        - command:
          - catalina.sh
          - run
          env:
          - name: CATALINA_BASE
            value: /usr/local/tomcat
          - name: OLS_CASSANDRA_LOCAL_DATACENTER
            value: DC1
          - name: OLS_CASSANDRA_CONTACT_POINT
            value: cassandra-${APP_NAME}
          - name: OLS_CASSANDRA_KEYSPACE
            value: bgeo
          image: docker-remote.artifacts.developer.gov.bc.ca/tomcat:9-jre11-slim
          imagePullPolicy: IfNotPresent
          name: tomcat
          ports:
          - containerPort: 8080
            name: catalina-http
            protocol: TCP
          resources:
            limits:
              cpu: "500m"
              memory: 2Gi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /usr/local/tomcat/logs
            name: tc-work
          - mountPath: /usr/local/tomcat/work
            name: tc-work
          - mountPath: /usr/local/tomcat/temp
            name: tc-work
          - mountPath: /usr/local/tomcat/conf/Catalina
            name: tc-conf
          - mountPath: /usr/local/tomcat/webapps
            name: app-volume
        dnsPolicy: ClusterFirst
        initContainers:
        - name: init-copy-war
          command:
          - cp
          - /ols-router-admin.war
          - /app/int.war
          image: image-registry.openshift-image-registry.svc:5000/${TOOLS_NAMESPACE}/ols-router-admin-sidecar:${DATA_ADMIN_IS_TAG}
          imagePullPolicy: Always
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /app
            name: app-volume

        - name: init-wait-for-cassandra
          image: docker-remote.artifacts.developer.gov.bc.ca/busybox:1.33.1
          # Wait for cassandra service cassandra-${APP_NAME} to be ready.
          # In other words, wait for cassandra to 'boot'
          #
          # /state-ledger/keyspace-bgeo-loaded is created by the first router
          # pod that runs; The first router pod has a series of init containers
          # which wait for cassandra to start, create the bgeo keyspace, and
          # finlally, load the bgeo keyspace with the required data.
          # /state-ledger/keyspace-bgeo-loaded indicates all init stages have
          # been completed
          command:
            - 'sh'
            - '-c'
            - while (:);
              do
                if test -f /state-ledger/keyspace-bgeo-loaded;
                then
                  break;
                fi;
                printf .;
                sleep 1;
              done;
              echo
              echo sleeping for 5 more seconds.
              sleep 5;
          volumeMounts:
          - name: state-ledger-vol
            mountPath: /state-ledger

        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        terminationGracePeriodSeconds: 30
        volumes:
        - emptyDir: {}
          name: tc-work
        - emptyDir: {}
          name: tc-conf
        - emptyDir: {}
          name: app-volume
        - name: state-ledger-vol
          persistentVolumeClaim:
            claimName: state-ledger

  status: {}

# Service for the Data Admin App
- kind: Service
  apiVersion: v1
  metadata:
    creationTimestamp: null
    name: ols-router-admin
  spec:
    ports:
    - name: ols-router-admin
      port: 8080
      protocol: TCP
      targetPort: 8080
    selector:
      app: ols-router-admin
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}

# Route for the Data Admin App
- kind: Route
  apiVersion: route.openshift.io/v1
  metadata:
    creationTimestamp: null
    name: ols-router-admin
  spec:
    host: ${ROUTER_ADMIN_HOSTNAME}-${ENV}.${ROUTE_SUBDOMAIN}
    path: /int/
    port:
      targetPort: ols-router-admin
    tls:
      termination: edge
    to:
      kind: Service
      name: ols-router-admin
      weight: 100
    wildcardPolicy: None
  status:
    ingress: null


# Network Policies
- kind: NetworkPolicy
  apiVersion: networking.k8s.io/v1
  metadata:
    name: allow-from-openshift-ingress
  spec:
    ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            network.openshift.io/policy-group: ingress
    podSelector: {}
    policyTypes:
    - Ingress

- kind: NetworkPolicy
  apiVersion: networking.k8s.io/v1
  metadata:
    name: allow-same-namespace
  spec:
    ingress:
    - from:
      - podSelector: {}
    podSelector: {}
    policyTypes:
    - Ingress

- kind: NetworkPolicy
  apiVersion: networking.k8s.io/v1
  metadata:
    name: deny-by-default
  spec:
    podSelector: {}
    policyTypes:
    - Ingress

- kind: NetworkPolicy
  apiVersion: networking.k8s.io/v1
  metadata:
    name: allow-traffic-from-gateway-to-${APP_NAME}-${ENV}
  spec:
    podSelector:
      matchLabels:
        app: ols-router-web
    ingress:
      - from:
          - namespaceSelector:
              matchLabels:
                environment: test
                name: 264e6f
      - from:
          - namespaceSelector:
              matchLabels:
                environment: prod
                name: 264e6f
